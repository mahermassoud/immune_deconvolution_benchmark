# Effect of signature vs. method
Notebook to see the effect of signature on accuracy. We will be taking
the signature from EPIC, and using it with different methods
and seeing the results

\cite{Schelker2017} provide three samples for which paired single cell and bulk
RNA-seq has been performed. We generate simulated bulk RNA-seq samples by
taking the average of the single cells and compare the simulated to the genuine
samples.
```{r, cache=TRUE}
bulk_mean = sapply(colnames(schelker_ovarian$expr_mat), function(donor) {
  ind = pData(single_cell_schelker$eset)$donor == donor
  apply(exprs(single_cell_schelker$eset)[,ind], 1, mean)
})
bulk_mean = apply(bulk_mean, 2, scale_to_million)
```

## Compare predicted fractions
Most importantly, we ask how consistent the methods' predictions are on simulated vs. genuine bulk RNA-seq samples. We run all methods on both datasets and compare the results.
```{r, cache=TRUE, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}
timer_indications = rep("OV", ncol(schelker_ovarian$expr_mat))
all_results_bulk = foreach(method = config$deconvolution_methods,
                           .final = function(x) {setNames(x, config$deconvolution_methods)}) %do% {
  deconvolute(schelker_ovarian$expr_mat, method, indications=timer_indications) %>%
    mutate(method=method) %>%
    mutate(source="bulk")
}

all_results_simulated = foreach(method=config$deconvolution_methods,
                                .final = function(x) {setNames(x, config$deconvolution_methods)}) %do% {
  deconvolute(bulk_mean, method, indications=timer_indications) %>%
    mutate(method=method) %>%
    mutate(source="mean")
}

all_results = bind_rows(all_results_bulk, all_results_simulated) %>%
  # select(cell_type, `7873M`, `7882M`, `7892M`, source, method) %>%
  gather(donor, fraction, -cell_type, -source, -method) %>%
  spread(source, fraction)

res_methods_validity = new.env()
res_methods_validity$all_results = all_results
```

```{r, fig.width=12, fig.height=10, echo=FALSE, fig.cap="Correlation of the methods' predictions on both simulated and genuine bulk RNA-seq samples"}
all_results %>%
  ggplot(aes(x = bulk, y=mean)) +
    geom_point(aes(colour=cell_type)) +
    facet_wrap(~method, scales="free") +
    stat_cor()
```

The same, but only with the cell types we look at:
```{r corr-only-cell-types, include=FALSE}
show_cell_types = c("B cell", "Dendritic cell", "Macrophage/Monocyte",
                    "NK cell", "T cell CD4+", "T cell CD4+ (non-regulatory)",
                    "T cell regulatory (Tregs)", "T cell CD8+",
                    "Cancer associated fibroblast", "Endothelial cell")

all_results_simulated2 = lapply(names(all_results_simulated), function(method) {
  all_results_simulated[[method]] %>%
    select(-method, -source) %>%
    map_result_to_celltypes(show_cell_types, method) %>%
    as_tibble(rownames="cell_type") %>%
    mutate(method=method, source="simulated")
})

all_results_bulk2 = lapply(names(all_results_bulk), function(method) {
  all_results_bulk[[method]] %>%
    select(-method, -source) %>%
    map_result_to_celltypes(show_cell_types, method) %>%
    as_tibble(rownames="cell_type") %>%
    mutate(method=method, source="bulk")
})

only_cd4 = c("epic", "timer") # methods that do not estimate subtypes of CD4+ T cells
# -> we don't include them in all methods, because it's a sum of the subtypes
# and therefore the corresponding values would be over-represented.

all_results2 = bind_rows(all_results_bulk2, all_results_simulated2) %>%
  # select(cell_type, `7873M`, `7882M`, `7892M`, source, method) %>%
  gather(donor, fraction, -cell_type, -source, -method) %>%
  spread(source, fraction) %>%
  filter(!(cell_type == "T cell CD4+" & !method %in% only_cd4))

res_methods_validity$all_results_mapped = all_results2
```
